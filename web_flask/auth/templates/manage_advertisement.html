<!-- templates/profile.html -->
{% extends "base.html" %}

{% block title %}My Wishlist{% endblock %}

{% block content %}

<div class="container-xxl bg-white p-0">
    <br>
    <header class="mb-4 text-center">
        <br>
        <br>
        <h4 style="color: #2c3e50;">Update Advertisement Images</h4> <!-- Dark blue heading -->
        <h6 style="color: #6c0f29;">Image size : 1000x1000 pixels</h6> <!-- Light gray description -->
    </header>

    <!-- Back Button -->
    <div class="text-center mb-3">
        <a href="{{ url_for('app_views_auth.admin_panel') }}" class="btn btn-outline-primary">Back</a>
    </div>

    <div class="container">
        <form method="POST" action="{{ url_for('app_views_auth.manage_advertisement') }}" enctype="multipart/form-data">
            <div class="row">
                {% for i in range(1, 7) %}
                <div class="col-md-6 mb-3">
                    <label for="mainImage{{ i }}" class="form-label">Image {{ i }}</label>
    
                    <!-- Display the existing image if available -->
                    {% if existing_images[i-1] %}
                        <img src="{{ url_for('.static', filename='img/' + existing_images[i-1]) }}" alt="Image {{ i }}" class="img-thumbnail mb-2" style="max-width: 100%; height: auto;">
                    {% endif %}
            
                    <!-- File input for new image -->
                    <input type="file" class="form-control" id="mainImage{{ i }}" name="mainImage{{ i }}" accept="image/*">
                </div>
                {% endfor %}
            </div>
            <header class="mb-4 text-center">
                <br>
                <br>
                <h4 style="color: #2c3e50;">Update Agents</h4> <!-- Dark blue heading -->
                <h6 style="color: #6c0f29;">Image size : 400x400 pixels</h6> <!-- Light gray description -->
            </header>
    
            <div class="row">
                {% for agent in existing_agents %}
                <div class="col-md-6 mb-3">
                    <!-- Hidden input to store the agent's id -->
                    <input type="hidden" name="agentIds" value="{{ agent['id'] }}">
                
                    <!-- Input field to update the agent's name -->
                    <label for="agentName{{ agent['id'] }}" class="form-label">
                        Agent Name ({{ agent['name'] }})
                    </label>
                    <input type="text" class="form-control" 
                           id="agentName{{ agent['id'] }}" 
                           name="agentNames" 
                           value="{{ agent['name'] }}" 
                           required>
                    
                    <!-- Display the existing agent image if available -->
                    {% if agent['image'] %}
                    <div class="image-container">
                        <img src="{{ url_for('.static', filename='img/agents/' + agent['image']) }}" 
                             alt="Image of {{ agent['name'] }}" 
                             class="img-thumbnail mb-2" style="max-width: 100%; height: auto;">
                        <!-- Delete button to remove the image -->
                        <button type="button" class="btn btn-danger btn-sm mt-2" 
                                onclick="deleteImage('{{ agent['id'] }}')">
                            Delete Image
                        </button>
                    </div>
                    {% endif %}
                    
                    <!-- File input for new agent image -->
                    <input type="file" class="form-control" 
                           id="mainImage{{ agent['id'] }}" 
                           name="agentImages" 
                           accept="image/*">
                </div>
                <script>
                    function deleteImage(agentId) {
                        // Confirm the action with the user
                        if (confirm('Are you sure you want to delete this image?')) {
                            
                            // Send an AJAX DELETE request to the server to remove the image
                            fetch(`/auth/delete-agent-image/${agentId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                            })
                            .then(response => response.json())
                            .then(data => {
                                // Check if the image was deleted successfully
                                if (data.success) {
                                    alert('Image deleted successfully');
                                    
                                    // Debug: Log to confirm that the page reload logic is being reached
                                    console.log("Image deleted, reloading the page...");
                                    
                                    // Reload the page
                                    window.location.href = window.location.href;  // Alternative way to reload the page
                                } else {
                                    alert('Failed to delete image');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while deleting the image.');
                            });
                        }
                    }
                </script>
                               
                {% endfor %}
            </div>                      
            <!-- Ask user for the number of fields       -->
            <div class="mb-3">
                <label for="agentFieldCount" class="form-label">How many agent images do you want to add?</label>
                <input type="number" class="form-control" id="agentFieldCount" name="agentFieldCount" min="1">
            </div>
            <div id="agentFieldsContainer" class="row">
                <!-- New fields will be added here dynamically -->
            </div>
    
            <div class="text-end mt-4">
                <button type="submit" class="btn btn-success">Save</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
